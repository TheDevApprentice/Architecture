/**
 * Keycloak Security Audit Integration Test Pipeline
 * 
 * Tests security audit functions: inactive users, unverified emails, report generation
 */

def keycloakAuth
def keycloakAudit

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'REALM',
            choices: ['internal'],
            description: 'Keycloak realm to test'
        )
    }
    
    environment {
        KC_URL_INTERNAL = "${KC_URL_INTERNAL}"
        KC_CLIENT_ID = "${KC_CLIENT_ID_JENKINS_AUTOMATION}"
        KC_CLIENT_SECRET = "${KC_SECRET_JENKINS_AUTOMATION}"
    }
    
    stages {
        stage('Load Libraries') {
            steps {
                script {
                    keycloakAuth = load '/var/jenkins_home/workflow-libs/keycloak-lib/vars/keycloakAuth.groovy'
                    keycloakAudit = load '/var/jenkins_home/workflow-libs/keycloak-lib/vars/keycloakAudit.groovy'
                    echo "âœ… Libraries loaded"
                }
            }
        }
        
        stage('ðŸ” Keycloak Connectivity') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 1: Checking Keycloak connectivity..."
                    echo "=" * 60
                    
                    try {
                        def wellKnownUrl = "http://${env.KC_URL_INTERNAL}/realms/${params.REALM}/.well-known/openid-configuration"
                        def response = sh(
                            script: "curl -s -o /dev/null -w '%{http_code}' ${wellKnownUrl}",
                            returnStdout: true
                        ).trim()
                        
                        if (response == '200') {
                            echo "âœ… Keycloak is accessible"
                            // echo "DEV : URL: ${wellKnownUrl}"
                        } else {
                            error("âŒ Keycloak returned HTTP ${response}")
                        }
                    } catch (Exception e) {
                        error("âŒ Failed to connect to Keycloak: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ” Service Account Authentication') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 2: Authenticating to Keycloak..."
                    echo "=" * 60
                    
                    env.ACCESS_TOKEN = keycloakAuth.getServiceAccountToken(
                        keycloakUrl: env.KC_URL_INTERNAL,
                        clientId: env.KC_CLIENT_ID,
                        clientSecret: env.KC_CLIENT_SECRET,
                        realm: params.REALM
                    )
                    
                    echo "âœ… Authentication successful"
                }
            }
        }
        
        stage('ðŸ“Š Test 1: Gather User Statistics') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 1: Gathering user statistics..."
                    echo "=" * 60
                    
                    try {
                        def stats = keycloakAudit.getUserStatistics(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM
                        )
                        
                        echo "âœ… Statistics gathered successfully"
                        echo "\nðŸ“Š User Statistics:"
                        echo "   Total users: ${stats.totalUsers}"
                        echo "   Enabled users: ${stats.enabledUsers}"
                        echo "   Disabled users: ${stats.disabledUsers}"
                        echo "   Verified emails: ${stats.verifiedEmails}"
                        echo "   Unverified emails: ${stats.unverifiedEmails}"
                        
                        env.TOTAL_USERS = stats.totalUsers.toString()
                    } catch (Exception e) {
                        error("âŒ Failed to gather statistics: ${e.message}")
                    }
                }
            }
        }
        
        stage('âš ï¸ Test 2: Find Inactive Users') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 2: Finding inactive users..."
                    echo "=" * 60
                    
                    try {
                        def inactiveUsers = keycloakAudit.findInactiveUsers(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            inactiveDays: 90
                        )
                        
                        echo "âœ… Inactive users analysis completed"
                        echo "   Users inactive for 90+ days: ${inactiveUsers.size()}"
                        
                        if (inactiveUsers.size() > 0) {
                            echo "\n   Sample inactive users:"
                            inactiveUsers.take(5).each { user ->
                                echo "   - ${user.username} (Last login: ${user.lastLogin ?: 'Never'})"
                            }
                        }
                    } catch (Exception e) {
                        error("âŒ Failed to find inactive users: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ“§ Test 3: Find Unverified Emails') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 3: Finding users with unverified emails..."
                    echo "=" * 60
                    
                    try {
                        def unverifiedUsers = keycloakAudit.findUnverifiedEmails(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM
                        )
                        
                        echo "âœ… Unverified emails analysis completed"
                        echo "   Users with unverified emails: ${unverifiedUsers.size()}"
                        
                        if (unverifiedUsers.size() > 0) {
                            echo "\n   Sample users:"
                            unverifiedUsers.take(5).each { user ->
                                echo "   - ${user.username} (${user.email})"
                            }
                        }
                    } catch (Exception e) {
                        error("âŒ Failed to find unverified emails: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ” Test 4: Check Password Policies') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 4: Checking password policies..."
                    echo "=" * 60
                    
                    try {
                        def policies = keycloakAudit.checkPasswordPolicies(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM
                        )
                        
                        echo "âœ… Password policies retrieved"
                        echo "\nðŸ” Password Policy Configuration:"
                        echo "   Minimum length: ${policies.minLength ?: 'Not configured'}"
                        echo "   Require digits: ${policies.requireDigits ?: 'No'}"
                        echo "   Require lowercase: ${policies.requireLowercase ?: 'No'}"
                        echo "   Require uppercase: ${policies.requireUppercase ?: 'No'}"
                        echo "   Require special chars: ${policies.requireSpecial ?: 'No'}"
                        echo "   Password history: ${policies.historyCount ?: '0'}"
                    } catch (Exception e) {
                        error("âŒ Failed to check password policies: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ“ Test 5: Generate Security Report (JSON)') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 5: Generating JSON security report..."
                    echo "=" * 60
                    
                    try {
                        def jsonReport = keycloakAudit.generateSecurityReport(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            format: 'json',
                            inactiveDaysThreshold: 90
                        )
                        
                        // Save report
                        writeFile file: "security-report-${BUILD_NUMBER}.json", text: jsonReport
                        
                        echo "âœ… JSON report generated"
                        echo "   File: security-report-${BUILD_NUMBER}.json"
                        
                        // Archive the report
                        archiveArtifacts artifacts: "security-report-${BUILD_NUMBER}.json", fingerprint: true
                        
                    } catch (Exception e) {
                        error("âŒ Failed to generate JSON report: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ“Š Test 6: Generate Security Report (HTML)') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 6: Generating HTML security report..."
                    echo "=" * 60
                    
                    try {
                        def htmlReport = keycloakAudit.generateSecurityReport(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            format: 'html',
                            inactiveDaysThreshold: 90,
                            inactiveUsersThreshold: 50,
                            unverifiedEmailThreshold: 20
                        )
                        
                        // Save report
                        writeFile file: "security-report-${BUILD_NUMBER}.html", text: htmlReport
                        
                        echo "âœ… HTML report generated"
                        echo "   File: security-report-${BUILD_NUMBER}.html"
                        
                        // Publish HTML report
                        publishHTML(target: [
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: '.',
                            reportFiles: "security-report-${BUILD_NUMBER}.html",
                            reportName: 'Security Audit Report'
                        ])
                        
                        echo "âœ… Report published to Jenkins"
                        
                    } catch (Exception e) {
                        error("âŒ Failed to generate HTML report: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸŽ¯ Test 7: Calculate Security Score') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 7: Calculating security score..."
                    echo "=" * 60
                    
                    try {
                        def score = keycloakAudit.calculateSecurityScore(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            inactiveDaysThreshold: 90
                        )
                        
                        echo "âœ… Security score calculated"
                        echo "\nðŸŽ¯ Security Score: ${score.totalScore}/100"
                        echo "\n   Breakdown:"
                        echo "   - Active users score: ${score.activeUsersScore}/30"
                        echo "   - Email verification score: ${score.emailVerificationScore}/20"
                        echo "   - Password policy score: ${score.passwordPolicyScore}/30"
                        echo "   - MFA adoption score: ${score.mfaScore}/20"
                        
                        def rating = score.totalScore >= 80 ? "ðŸŸ¢ Excellent" : 
                                    score.totalScore >= 60 ? "ðŸŸ¡ Good" :
                                    score.totalScore >= 40 ? "ðŸŸ  Fair" : "ðŸ”´ Poor"
                        
                        echo "\n   Overall Rating: ${rating}"
                        
                    } catch (Exception e) {
                        error("âŒ Failed to calculate score: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ” Test 8: Find Security Issues') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 8: Finding security issues..."
                    echo "=" * 60
                    
                    try {
                        def issues = keycloakAudit.findSecurityIssues(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            inactiveDaysThreshold: 90
                        )
                        
                        echo "âœ… Security issues identified"
                        echo "\nâš ï¸ Security Issues Found: ${issues.size()}"
                        
                        if (issues.size() > 0) {
                            issues.each { issue ->
                                def severity = issue.severity == 'HIGH' ? 'ðŸ”´' : 
                                             issue.severity == 'MEDIUM' ? 'ðŸŸ ' : 'ðŸŸ¡'
                                echo "\n   ${severity} ${issue.title}"
                                echo "      Category: ${issue.category}"
                                echo "      Impact: ${issue.description}"
                                echo "      Affected: ${issue.count} ${issue.type}"
                            }
                        } else {
                            echo "\nâœ… No critical security issues found!"
                        }
                        
                    } catch (Exception e) {
                        error("âŒ Failed to find security issues: ${e.message}")
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "\n" + "=" * 60
            echo "âœ… ALL TESTS PASSED"
            echo "=" * 60
            echo "\nSecurity Audit Integration Tests Summary:"
            echo "âœ… Gather user statistics"
            echo "âœ… Find inactive users"
            echo "âœ… Find unverified emails"
            echo "âœ… Check password policies"
            echo "âœ… Generate JSON report"
            echo "âœ… Generate HTML report"
            echo "âœ… Calculate security score"
            echo "âœ… Find security issues"
            echo "\nðŸŽ‰ Keycloak Security Audit is fully functional!"
            echo "\nðŸ“Š Reports available:"
            echo "   - JSON: security-report-${BUILD_NUMBER}.json"
            echo "   - HTML: Published in Jenkins"
        }
        failure {
            echo "\n" + "=" * 60
            echo "âŒ TESTS FAILED"
            echo "=" * 60
            echo "\nâš ï¸  Check the logs above for details"
        }
        always {
            script {
                echo "\nTest completed at: ${new Date()}"

                // Clean sensitive data
                env.ACCESS_TOKEN = null

                parameters.each { param ->
                    param.value = null
                }
            }
        }
    }
}
