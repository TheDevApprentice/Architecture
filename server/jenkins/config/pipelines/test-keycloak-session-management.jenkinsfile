/**
 * Keycloak Session Management Integration Test Pipeline
 * 
 * Tests session operations: list, revoke, statistics, anomaly detection
 */

def keycloakAuth
def keycloakSession
def keycloakUser

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'REALM',
            choices: ['internal'],
            description: 'Keycloak realm to test'
        )
    }
    
    environment {
        KC_URL_INTERNAL = "${KC_URL_INTERNAL}"
        KC_CLIENT_ID = "${KC_CLIENT_ID_JENKINS_AUTOMATION}"
        KC_CLIENT_SECRET = "${KC_SECRET_JENKINS_AUTOMATION}"
        TEST_USERNAME = "test-session-user-${BUILD_NUMBER}"
    }
    
    stages {
        stage('Load Libraries') {
            steps {
                script {
                    keycloakAuth = load '/var/jenkins_home/workflow-libs/keycloak-lib/vars/keycloakAuth.groovy'
                    keycloakSession = load '/var/jenkins_home/workflow-libs/keycloak-lib/vars/keycloakSession.groovy'
                    keycloakUser = load '/var/jenkins_home/workflow-libs/keycloak-lib/vars/keycloakUser.groovy'
                    echo "âœ… Libraries loaded"
                }
            }
        }
        
        stage('ðŸ” Authenticate') {
            steps {
                script {
                    echo "=" * 60
                    echo "Authenticating to Keycloak..."
                    echo "=" * 60
                    
                    env.ACCESS_TOKEN = keycloakAuth.getServiceAccountToken(
                        keycloakUrl: env.KC_URL_INTERNAL,
                        clientId: env.KC_CLIENT_ID,
                        clientSecret: env.KC_CLIENT_SECRET,
                        realm: params.REALM
                    )
                    
                    echo "âœ… Authentication successful"
                }
            }
        }
        
        stage('ðŸ‘¤ Setup: Create Test User') {
            steps {
                script {
                    echo "=" * 60
                    echo "SETUP: Creating test user for session testing..."
                    echo "=" * 60
                    
                    try {
                        env.TEST_USER_ID = keycloakUser.createUser(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            username: env.TEST_USERNAME,
                            email: "${env.TEST_USERNAME}@test.local",
                            password: "Test123!",
                            enabled: true,
                            emailVerified: true
                        )
                        
                        echo "âœ… Test user created"
                        echo "   Username: ${env.TEST_USERNAME}"
                        echo "   User ID: ${env.TEST_USER_ID}"
                    } catch (Exception e) {
                        error("âŒ Failed to create test user: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ“Š Test 1: Get Session Statistics') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 1: Gathering session statistics..."
                    echo "=" * 60
                    
                    try {
                        def stats = keycloakSession.getSessionStatistics(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM
                        )
                        
                        echo "âœ… Session statistics retrieved"
                        echo "\nðŸ“Š Session Statistics:"
                        echo "   Active sessions: ${stats.activeSessions}"
                        echo "   Offline sessions: ${stats.offlineSessions}"
                        echo "   Total clients: ${stats.totalClients}"
                        echo "   Sessions per client:"
                        
                        stats.clientSessions?.take(5)?.each { client ->
                            echo "      - ${client.clientId}: ${client.active} active"
                        }
                    } catch (Exception e) {
                        error("âŒ Failed to get statistics: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ“‹ Test 2: List Active Sessions') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 2: Listing all active sessions..."
                    echo "=" * 60
                    
                    try {
                        def sessions = keycloakSession.listActiveSessions(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            max: 50
                        )
                        
                        echo "âœ… Active sessions retrieved"
                        echo "   Total active sessions: ${sessions.size()}"
                        
                        if (sessions.size() > 0) {
                            echo "\n   Sample sessions:"
                            sessions.take(5).each { session ->
                                echo "   - Session ID: ${session.id}"
                                echo "     User: ${session.username}"
                                echo "     Started: ${session.start}"
                                echo "     IP: ${session.ipAddress}"
                                echo "     Clients: ${session.clients?.join(', ')}"
                                echo ""
                            }
                        }
                    } catch (Exception e) {
                        error("âŒ Failed to list sessions: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ‘¤ Test 3: List User Sessions') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 3: Listing sessions for specific user..."
                    echo "=" * 60
                    
                    try {
                        // Try to get sessions for admin user (more likely to have sessions)
                        def adminUsers = keycloakUser.listUsers(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            max: 1
                        )
                        
                        if (adminUsers.size() > 0) {
                            def testUserId = adminUsers[0].id
                            
                            def userSessions = keycloakSession.listUserSessions(
                                keycloakUrl: env.KC_URL_INTERNAL,
                                accessToken: env.ACCESS_TOKEN,
                                realm: params.REALM,
                                userId: testUserId
                            )
                            
                            echo "âœ… User sessions retrieved"
                            echo "   User: ${adminUsers[0].username}"
                            echo "   Active sessions: ${userSessions.size()}"
                            
                            if (userSessions.size() > 0) {
                                userSessions.each { session ->
                                    echo "\n   Session Details:"
                                    echo "      Session ID: ${session.id}"
                                    echo "      Started: ${session.start}"
                                    echo "      Last access: ${session.lastAccess}"
                                    echo "      IP: ${session.ipAddress}"
                                }
                            } else {
                                echo "   â„¹ï¸  No active sessions for this user"
                            }
                        }
                    } catch (Exception e) {
                        echo "âš ï¸  Warning: ${e.message}"
                        echo "   (This is expected if no users have active sessions)"
                    }
                }
            }
        }
        
        stage('ðŸ” Test 4: Detect Session Anomalies') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 4: Detecting session anomalies..."
                    echo "=" * 60
                    
                    try {
                        def anomalies = keycloakSession.detectAnomalies(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            maxSessionAgeDays: 7,
                            suspiciousIPPatterns: ['10.0.0.*', '192.168.*']
                        )
                        
                        echo "âœ… Anomaly detection completed"
                        echo "\nâš ï¸ Anomalies Found: ${anomalies.size()}"
                        
                        if (anomalies.size() > 0) {
                            anomalies.take(5).each { anomaly ->
                                echo "\n   ðŸ”´ ${anomaly.type}"
                                echo "      Session ID: ${anomaly.sessionId}"
                                echo "      User: ${anomaly.username}"
                                echo "      Issue: ${anomaly.description}"
                                echo "      Age: ${anomaly.ageInDays} days"
                            }
                        } else {
                            echo "\n   âœ… No anomalies detected"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸  Warning: ${e.message}"
                        echo "   (Anomaly detection may not find issues in test environment)"
                    }
                }
            }
        }
        
        stage('â±ï¸ Test 5: Find Long-Running Sessions') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 5: Finding long-running sessions..."
                    echo "=" * 60
                    
                    try {
                        def longSessions = keycloakSession.findLongRunningSessions(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            thresholdDays: 7
                        )
                        
                        echo "âœ… Long-running sessions analysis completed"
                        echo "   Sessions running > 7 days: ${longSessions.size()}"
                        
                        if (longSessions.size() > 0) {
                            echo "\n   Long-running sessions:"
                            longSessions.take(5).each { session ->
                                echo "   - ${session.username}: ${session.ageInDays} days"
                                echo "     Session ID: ${session.id}"
                            }
                        } else {
                            echo "   âœ… No long-running sessions found"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸  Warning: ${e.message}"
                    }
                }
            }
        }
        
        stage('ðŸ—‘ï¸ Test 6: Revoke User Sessions (Test User)') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 6: Testing session revocation..."
                    echo "=" * 60
                    
                    try {
                        // Revoke sessions for our test user (won't have any, but tests the endpoint)
                        keycloakSession.revokeUserSessions(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            userId: env.TEST_USER_ID
                        )
                        
                        echo "âœ… Session revocation successful"
                        echo "   User: ${env.TEST_USERNAME}"
                        echo "   All sessions for this user have been revoked"
                        
                    } catch (Exception e) {
                        error("âŒ Failed to revoke sessions: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ“Š Test 7: Generate Session Report') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 7: Generating session management report..."
                    echo "=" * 60
                    
                    try {
                        def report = keycloakSession.generateSessionReport(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            format: 'json',
                            includeAnomalies: true,
                            maxSessionAgeDays: 7
                        )
                        
                        // Save report
                        writeFile file: "session-report-${BUILD_NUMBER}.json", text: report
                        
                        echo "âœ… Session report generated"
                        echo "   File: session-report-${BUILD_NUMBER}.json"
                        
                        // Archive
                        archiveArtifacts artifacts: "session-report-${BUILD_NUMBER}.json", fingerprint: true
                        
                        echo "\n   Report includes:"
                        echo "   - Active session count"
                        echo "   - Session statistics by client"
                        echo "   - Detected anomalies"
                        echo "   - Long-running sessions"
                        
                    } catch (Exception e) {
                        error("âŒ Failed to generate report: ${e.message}")
                    }
                }
            }
        }
        
        stage('ðŸ—‘ï¸ Test 8: Cleanup') {
            steps {
                script {
                    echo "=" * 60
                    echo "TEST 8: Cleaning up test user..."
                    echo "=" * 60
                    
                    try {
                        keycloakUser.deleteUser(
                            keycloakUrl: env.KC_URL_INTERNAL,
                            accessToken: env.ACCESS_TOKEN,
                            realm: params.REALM,
                            userId: env.TEST_USER_ID
                        )
                        
                        echo "âœ… Test user deleted"
                        echo "\nâœ… All test resources cleaned up"
                    } catch (Exception e) {
                        echo "âš ï¸ Cleanup warning: ${e.message}"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "\n" + "=" * 60
            echo "âœ… ALL TESTS PASSED"
            echo "=" * 60
            echo "\nSession Management Integration Tests Summary:"
            echo "âœ… Get session statistics"
            echo "âœ… List active sessions"
            echo "âœ… List user sessions"
            echo "âœ… Detect session anomalies"
            echo "âœ… Find long-running sessions"
            echo "âœ… Revoke user sessions"
            echo "âœ… Generate session report"
            echo "âœ… Cleanup"
            echo "\nðŸŽ‰ Keycloak Session Management is fully functional!"
            echo "\nðŸ“Š Report available: session-report-${BUILD_NUMBER}.json"
        }
        failure {
            echo "\n" + "=" * 60
            echo "âŒ TESTS FAILED"
            echo "=" * 60
            echo "\nâš ï¸  Check the logs above for details"
        }
        always {
            echo "\nTest completed at: ${new Date()}"

            // Clean sensitive data
            env.ACCESS_TOKEN = null

            parameters.each { param ->
                param.value = null
            }
        }
    }
}
